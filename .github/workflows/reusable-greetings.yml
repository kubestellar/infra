name: Reusable Greetings

on:
  workflow_call:
    inputs:
      pr_message:
        description: 'Message to post for first-time PR contributors'
        required: false
        type: string
        default: |
          Welcome to KubeStellar! ðŸš€ Thank you for submitting your first Pull Request.

          **Before your PR can be merged, please ensure:**

          âœ… **DCO Sign-off** - All commits must be signed off with `git commit -s` to certify the [Developer Certificate of Origin](https://developercertificate.org/)

          âœ… **PR Title** - Must start with an emoji: âœ¨ (feature), ðŸ› (bug fix), ðŸ“– (docs), ðŸŒ± (infra/tests), âš ï¸ (breaking change)

          **Getting Started with KubeStellar:**
          - ðŸ“¦ [Installation Guide](https://docs.kubestellar.io/stable/direct/get-started/)
          - ðŸ“– [Documentation](https://docs.kubestellar.io/)
          - ðŸŽ¬ [YouTube - Getting Started & Contributing](https://www.youtube.com/@kubestellar)

          **Contributor Resources:**
          - ðŸ“š [Contributor Handbook](https://kubestellar.io/contribute-handbook)
          - ðŸªœ [Contributor Ladder](https://kubestellar.io/ladder)
          - ðŸŽ“ [Mentorship Programs (LFX, GSoC)](https://kubestellar.io/programs)
          - ðŸ’¬ [Slack - #kubestellar-dev](https://cloud-native.slack.com/archives/C097094RZ3M)

          ---

          ðŸŒŸ **Help KubeStellar Grow - We Need Adopters!**

          Our roadmap is driven entirely by adopter feedback. Whether you're using KubeStellar yourself or know someone who could benefit from multi-cluster Kubernetes:

          ðŸ“‹ **[Take our Multi-Cluster Survey](https://forms.gle/VsG6aJpikf3NKjJH6)** - Share your use cases and help shape our direction!

          ---

          A maintainer will review your PR soon. Feel free to ask questions in the comments or on Slack!
      issue_message:
        description: 'Message to post for first-time issue creators'
        required: false
        type: string
        default: |
          Welcome to KubeStellar! ðŸš€ Thank you for opening your first issue.

          **To work on this issue**, use the slash command:
          ```
          /assign
          ```
          This will automatically assign the issue to you. Use `/unassign` to remove yourself.

          **Find Issues to Work On:**
          - ðŸ·ï¸ [`good first issue`](https://github.com/kubestellar/kubestellar/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22) - Great for new contributors
          - ðŸ™‹ [`help wanted`](https://github.com/kubestellar/kubestellar/issues?q=is%3Aissue+is%3Aopen+label%3A%22help+wanted%22) - Community help needed
          - ðŸ” [CLOTributor](https://clotributor.dev/search?project=kubestellar&foundation=cncf&page=1) - CNCF issue finder

          **Getting Started with KubeStellar:**
          - ðŸ“¦ [Installation Guide](https://docs.kubestellar.io/stable/direct/get-started/)
          - ðŸ“– [Documentation](https://docs.kubestellar.io/)
          - ðŸŽ¬ [YouTube - Getting Started & Contributing](https://www.youtube.com/@kubestellar)

          **Contributor Resources:**
          - ðŸ“š [Contributor Handbook](https://kubestellar.io/contribute-handbook)
          - ðŸªœ [Contributor Ladder](https://kubestellar.io/ladder)
          - ðŸŽ“ [Mentorship Programs (LFX, GSoC)](https://kubestellar.io/programs)
          - ðŸ’¬ [Slack - #kubestellar-dev](https://cloud-native.slack.com/archives/C097094RZ3M)

          **For Maintainers - Label Commands:**
          - `/good-first-issue` - Mark this issue as suitable for new contributors
          - `/help-wanted` - Mark this issue as needing community help

          ---

          ðŸŒŸ **Help KubeStellar Grow - We Need Adopters!**

          Our roadmap is driven entirely by adopter feedback. Whether you're using KubeStellar yourself or know organizations that could benefit from multi-cluster Kubernetes:

          ðŸ“‹ **[Take our Multi-Cluster Survey](https://forms.gle/VsG6aJpikf3NKjJH6)** - Share your use cases and help shape our direction!

          ---

          We're excited to have you in our community!
      check_org_wide:
        description: 'Check org-wide contributions instead of just this repo'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  greeting:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Check and greet first-time contributor
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          PR_MESSAGE: ${{ inputs.pr_message }}
          ISSUE_MESSAGE: ${{ inputs.issue_message }}
          CHECK_ORG_WIDE: ${{ inputs.check_org_wide }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const author = context.payload.pull_request?.user?.login || context.payload.issue?.user?.login;
            const isPR = !!context.payload.pull_request;
            const itemNumber = context.payload.pull_request?.number || context.payload.issue?.number;

            if (!author || !itemNumber) {
              console.log('Could not determine author or item number');
              return;
            }

            // Skip bots
            if (author.endsWith('[bot]') || author === 'dependabot' || author === 'github-actions') {
              console.log(`Skipping bot: ${author}`);
              return;
            }

            const checkOrgWide = process.env.CHECK_ORG_WIDE === 'true';
            console.log(`Checking contributions for ${author} (org-wide: ${checkOrgWide})`);

            let hasContributed = false;

            if (checkOrgWide) {
              // Check org-wide contributions - any merged PR or closed issue
              try {
                const { data: orgPRs } = await github.rest.search.issuesAndPullRequests({
                  q: `org:${owner} author:${author} is:pr is:merged`,
                  per_page: 1
                });
                if (orgPRs.total_count > 0) {
                  hasContributed = true;
                  console.log(`${author} has ${orgPRs.total_count} merged PRs in the org`);
                }
              } catch (e) {
                console.log(`Error checking org PRs: ${e.message}`);
              }

              // Also check for any open PRs (excluding current one)
              if (!hasContributed) {
                try {
                  const { data: openPRs } = await github.rest.search.issuesAndPullRequests({
                    q: `org:${owner} author:${author} is:pr is:open`,
                    per_page: 10
                  });
                  // Exclude current PR from count
                  const otherPRs = openPRs.items.filter(pr => pr.number !== itemNumber);
                  if (otherPRs.length > 0) {
                    hasContributed = true;
                    console.log(`${author} has ${otherPRs.length} other open PRs in the org`);
                  }
                } catch (e) {
                  console.log(`Error checking open PRs: ${e.message}`);
                }
              }

              // Check for issues created
              if (!hasContributed) {
                try {
                  const { data: orgIssues } = await github.rest.search.issuesAndPullRequests({
                    q: `org:${owner} author:${author} is:issue`,
                    per_page: 1
                  });
                  // Exclude current issue if applicable
                  const count = orgIssues.total_count - (isPR ? 0 : 1);
                  if (count > 0) {
                    hasContributed = true;
                    console.log(`${author} has ${count} issues in the org`);
                  }
                } catch (e) {
                  console.log(`Error checking org issues: ${e.message}`);
                }
              }
            } else {
              // Check repo-only contributions
              try {
                const { data: repoPRs } = await github.rest.pulls.list({
                  owner,
                  repo,
                  state: 'all',
                  per_page: 100
                });
                const authorPRs = repoPRs.filter(pr => pr.user.login === author && pr.number !== itemNumber);
                if (authorPRs.length > 0) {
                  hasContributed = true;
                  console.log(`${author} has ${authorPRs.length} PRs in this repo`);
                }
              } catch (e) {
                console.log(`Error checking repo PRs: ${e.message}`);
              }
            }

            if (hasContributed) {
              console.log(`${author} is not a first-time contributor, skipping greeting`);
              return;
            }

            console.log(`${author} is a first-time contributor, posting greeting`);

            const message = isPR ? process.env.PR_MESSAGE : process.env.ISSUE_MESSAGE;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: itemNumber,
              body: message
            });

            console.log('Greeting posted successfully');
