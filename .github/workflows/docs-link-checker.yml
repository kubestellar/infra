name: Docs Link Checker

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Check links on kubestellar.io
        id: check
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
        run: |
          set -euo pipefail

          # Install lychee link checker
          curl -sLO https://github.com/lycheeverse/lychee/releases/download/v0.15.1/lychee-v0.15.1-x86_64-unknown-linux-gnu.tar.gz
          tar xzf lychee-v0.15.1-x86_64-unknown-linux-gnu.tar.gz
          chmod +x lychee

          # Create output directory
          mkdir -p results

          # Check kubestellar.io (main site)
          echo "Checking kubestellar.io..."
          ./lychee --no-progress --format json --output results/main.json \
            --exclude "github.com.*edit" \
            --exclude "linkedin.com" \
            --exclude "twitter.com" \
            --exclude "x.com" \
            --exclude "slack.com" \
            --exclude "forms.gle" \
            --exclude "localhost" \
            --exclude "127.0.0.1" \
            --max-redirects 5 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            "https://kubestellar.io" || true

          # Check docs site
          echo "Checking docs.kubestellar.io..."
          ./lychee --no-progress --format json --output results/docs.json \
            --exclude "github.com.*edit" \
            --exclude "linkedin.com" \
            --exclude "twitter.com" \
            --exclude "x.com" \
            --exclude "slack.com" \
            --exclude "forms.gle" \
            --exclude "localhost" \
            --exclude "127.0.0.1" \
            --max-redirects 5 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            "https://docs.kubestellar.io" || true

          # Combine and extract 404 errors
          echo "Processing results..."
          cat results/*.json 2>/dev/null | jq -s 'add' > results/combined.json || echo '{"fail_map":{}}' > results/combined.json

          # Extract failed URLs
          jq -r '.fail_map // {} | to_entries[] | "\(.key)|\(.value[0].status // "unknown")"' results/combined.json > results/broken_links.txt || touch results/broken_links.txt

          echo "Found broken links:"
          cat results/broken_links.txt || echo "None"

          # Count broken links
          broken_count=$(wc -l < results/broken_links.txt | tr -d ' ')
          echo "broken_count=$broken_count" >> $GITHUB_OUTPUT

      - name: Create issues for broken links
        if: steps.check.outputs.broken_count > 0
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
        run: |
          set -euo pipefail

          # Check each broken link and create issue if not already exists
          while IFS='|' read -r url status; do
            [ -z "$url" ] && continue

            # Create a unique identifier for the issue
            url_hash=$(echo "$url" | md5sum | cut -c1-8)
            issue_title="ðŸ› Broken link: $url"

            # Check if issue already exists (open or closed recently)
            existing=$(gh issue list --repo kubestellar/docs --search "Broken link: $url_hash in:title" --state all --json number --jq '.[0].number' 2>/dev/null || echo "")

            if [ -n "$existing" ] && [ "$existing" != "null" ]; then
              echo "Issue already exists for $url (issue #$existing)"
              continue
            fi

            # Create new issue
            echo "Creating issue for broken link: $url (status: $status)"
            gh issue create --repo kubestellar/docs \
              --title "$issue_title" \
              --label "help wanted,bug,documentation" \
              --body "## Broken Link Detected

**URL:** $url
**Status:** $status
**Hash:** $url_hash

This broken link was automatically detected by the link checker workflow.

### How to fix
1. Find where this URL is referenced in the docs
2. Either update the URL to a working one, or remove the reference if no longer relevant
3. Submit a PR with the fix

---
ðŸ¤– Auto-generated by [docs-link-checker](https://github.com/kubestellar/infra/actions/workflows/docs-link-checker.yml)" || echo "Failed to create issue for $url"

            # Rate limit to avoid API issues
            sleep 2
          done < results/broken_links.txt

          echo "Done processing broken links"
