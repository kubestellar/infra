name: Sync Workflows to All Repos

on:
  push:
    branches: [main]
    paths:
      - 'caller-workflows/**'
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all workflows to all repos'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  get-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    steps:
      - name: Get list of repos
        id: get-repos
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
        run: |
          # Get all repos in org, excluding .github, infra, private repos, and archived repos
          # Private repos (core, homebrew-kubestellar) are excluded because some workflows like scorecard don't work with them
          repos=$(gh repo list kubestellar --limit 100 --json name,isArchived,isPrivate --jq '[.[] | select(.isArchived == false and .isPrivate == false) | .name | select(. != ".github" and . != "infra")]')
          echo "repos=$repos" >> $GITHUB_OUTPUT
          echo "Found repos: $repos"

  sync:
    needs: get-repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repo: ${{ fromJson(needs.get-repos.outputs.repos) }}
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: kubestellar/${{ matrix.repo }}
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
          path: target

      - name: Sync workflows
        id: sync
        run: |
          # Create workflows directory if it doesn't exist
          mkdir -p target/.github/workflows

          # List of workflows to sync
          WORKFLOWS="add-help-wanted.yml assignment-helper.yml copilot-dco.yml feedback.yml greetings.yml label-helper.yml pr-verifier.yml pr-verify-title.yml scorecard.yml stale.yml"

          changed=false
          for wf in $WORKFLOWS; do
            src="source/caller-workflows/$wf"
            dst="target/.github/workflows/$wf"

            if [[ -f "$src" ]]; then
              # Check if file is different or doesn't exist
              if [[ ! -f "$dst" ]] || ! diff -q "$src" "$dst" > /dev/null 2>&1; then
                cp "$src" "$dst"
                changed=true
                echo "Updated: $wf"
              fi
            fi
          done

          echo "changed=$changed" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.sync.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
          path: target
          branch: sync/workflows-from-infra
          delete-branch: true
          title: "ðŸŒ± Sync workflows from kubestellar/infra"
          body: |
            This PR syncs the caller workflows from `kubestellar/infra`.

            These workflows call reusable workflows from `kubestellar/infra`:
            - `add-help-wanted.yml`
            - `assignment-helper.yml`
            - `copilot-dco.yml`
            - `feedback.yml`
            - `greetings.yml`
            - `label-helper.yml`
            - `pr-verifier.yml`
            - `pr-verify-title.yml`
            - `scorecard.yml`
            - `stale.yml`

            Auto-generated by workflow sync
          commit-message: "ðŸŒ± Sync workflows from kubestellar/infra"
          committer: GitHub Actions <noreply@github.com>
          author: GitHub Actions <noreply@github.com>
